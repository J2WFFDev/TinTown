# TinTown BLE Bridge Development Handoff - September 9, 2025

## Executive Summary

Successfully implemented and validated **raw count calibration system** for BT50 sensor impact detection. Resolved scale factor confusion by implementing simple baseline subtraction approach using raw integer counts. System now provides stable, reliable impact detection without floating-point scaling issues.

**Key Achievement**: Implemented robust calibration-based impact detection using raw sensor counts with 50-count threshold, eliminating scale factor complexities and achieving stable baseline tracking.

## Primary Objectives Completed

1. âœ… **Resolved Scale Factor Issues** - Eliminated confusion between 0.000425 vs 0.000902 scale factors
2. âœ… **Implemented Raw Count Approach** - Direct integer math using baseline subtraction
3. âœ… **Validated Calibration System** - Updated baseline X=2089 from session 20250909_174244
4. âœ… **Achieved Dual Device Connection** - Both AMG timer and BT50 sensor working simultaneously
5. âœ… **Verified Movement Detection** - Y/Z axes responding correctly to sensor orientation changes
6. âœ… **Decoded AMG Protocol** - Complete 14-byte frame structure with accurate shot counting
7. âœ… **Eliminated Shot Over-Detection** - Only counting 0x03 frame types as actual shots

## Critical Implementation Requirements

### **ðŸš¨ CALIBRATION REQUIREMENT - START OF BRIDGE**

**MANDATORY**: The bridge **MUST** perform calibration at startup to establish current baseline values before beginning impact detection.

#### Implementation Requirements:
1. **Run calibration routine** similar to `tools/calibrate_bt50_with_logging.py` at bridge startup
2. **Extract raw count baselines** from calibration results:
   - X-axis: Current gravity-oriented axis baseline (e.g., 2170 counts)
   - Y-axis: Current baseline (typically 0)
   - Z-axis: Current baseline (typically 0)
3. **Update baseline constants** in bridge configuration before starting detection
4. **Log calibration results** for traceability and debugging

#### Why This is Critical:
- **Sensor orientation changes**: Baseline varies with how sensor is mounted
- **Environmental factors**: Temperature, power, etc. affect raw readings
- **Hardware variations**: Each sensor unit has slightly different baselines
- **Reliability**: Raw count approach is stable, but requires accurate baseline

#### Current Baseline Values (Session 20250909_174244):
```python
BASELINE_X = 2089  # Raw counts - X-axis when vertical (updated from fresh calibration)
BASELINE_Y = 0     # Raw counts - Y-axis baseline  
BASELINE_Z = 0     # Raw counts - Z-axis baseline
IMPACT_THRESHOLD = 150  # Raw counts - Detect changes > 150 counts (3x normal variation)
```

## Technical Implementation

### Fixed Bridge Architecture (`scripts/fixed_bridge.py`)

#### Raw Count Processing
- **Input**: BT50 notification frames with `0x55 0x61` headers
- **Parser**: Extracts raw int16 values from offsets 14, 16, 26
- **Baseline Subtraction**: `corrected = raw - baseline`
- **Impact Detection**: `magnitude = sqrt(xÂ² + yÂ² + zÂ²) > 150 counts`

#### AMG Protocol Decoding (Breakthrough Achievement ðŸŽ¯)
- **Frame Structure**: 14-byte frames (not 32-byte as originally expected)
- **Frame Types**: `01 05` = START, `01 03` = SHOT, `01 08` = STOP
- **Shot Detection**: Only frames with `data[1] == 0x03` are actual shots
- **String Tracking**: Byte 13 contains string number (1, 2, 3...)
- **Timing Data**: Bytes 4-11 contain shot timings in centiseconds (big-endian)

#### AMG Frame Format (14 bytes):
```
Byte 0-1:  01 0X = Frame type (03=SHOT, 05=START, 08=STOP)
Byte 2:    Shot number within string (01, 02, 03...)  
Byte 3:    Total shots in current string
Byte 4-5:  Current shot time (big-endian, centiseconds)
Byte 6-7:  Split time (time since last shot)
Byte 8-9:  Time from string start
Byte 10-11: Total elapsed time  
Byte 12:   00 (reserved)
Byte 13:   String number (01, 02, 03)
```

#### Advantages of Raw Count Approach
1. **No Scale Factor Confusion** - Work directly with sensor integers
2. **Integer Math Only** - Eliminates floating-point precision issues
3. **Self-Calibrating** - Baseline adjusts to current orientation
4. **Stable Thresholds** - "50 counts" is clear and repeatable
5. **Debugging Friendly** - Raw values are easy to inspect and verify

### Connection Management

#### Device Status (Validated 2025-09-09)
- **AMG Timer**: `60:09:C3:1F:DC:1A` - âœ… Connected and providing shot notifications
- **BT50 Sensor**: `F8:FE:92:31:12:E3` - âœ… Connected and streaming at ~30Hz
- **BLE Reset Tool**: `tools/reset_ble.py` - âœ… Clears hanging connections effectively

#### Observed Behavior
- **Baseline Stability**: Raw counts vary Â±30 around baseline during normal operation
- **Movement Detection**: Clear response when sensor moved (Y=204, Z=18 during test)
- **Timer Integration**: AMG notifications correlate with sensor events
- **Connection Recovery**: BLE reset tool resolves connection issues

## Validation Results

### AMG Protocol Validation (3-String Test Results)

#### Test Results (2025-09-09 19:05)
- **String 1**: 3 shots detected accurately
- **String 2**: 4 shots detected accurately  
- **String 3**: 5 shots detected accurately
- **Total**: 12 shots with **zero over-detection**
- **Impact Correlation**: 6 BT50 impacts detected during test

#### Protocol Accuracy Achieved
- **Previous Issue**: Counting all AMG frames (6 frames = 2 shots + 4 status)
- **Solution**: Filter for frame type `0x03` only
- **Result**: Perfect 1:1 correlation between actual shots and detected shots

### Calibration Session 20250909_174244 (Updated)
```
Fresh calibration baseline: X=2089 Â±37 counts
Normal variation observed: 57 counts (2070-2127 range)
Threshold set: 150 counts (3x normal variation)
Impact detection: 154-350 count magnitudes observed
```

### Impact Detection Test Results
- **Stationary**: Magnitude 0-37 counts (normal variation around baseline)
- **Impacts**: Magnitude 154-350 counts (clear separation from baseline)
- **Threshold**: 150 counts provides excellent separation
- **False Positives**: None observed during 3-string test

## Next Steps & Development Priorities

1. **ðŸŽ¯ PRIMARY: Parse AMG Event Details** 
   - Extract timing data from AMG frame bytes 4-11 (shot time, split time, etc.)
   - Replace raw frame hex in event details with parsed timing information
   - Enable shot-to-impact timing correlation analysis

2. **Integrate Startup Calibration**: Modify bridge to run calibration and update baselines automatically
3. **Production Testing**: Validate with actual steel plate impacts in range environment
4. **Shot-to-Impact Correlation**: Use parsed AMG timing + BT50 timestamps for precise impact analysis
5. **System Deployment**: Package for production Raspberry Pi deployment

## Technical Debt & Future Enhancements

- **Event Detail Enhancement**: Current logs store raw hex frames - should parse to timing data
- **Correlation Analysis**: With parsed timing, can measure shot-to-impact delays accurately
- **Threshold Optimization**: 150-count threshold validated, may need range-specific tuning
- **Automated Calibration**: Bridge should auto-calibrate on startup for zero-touch operation

## File Locations

### Production Files
- **Fixed Bridge**: `scripts/fixed_bridge.py` - Raw count + AMG protocol implementation
- **Calibration Tool**: `tools/calibrate_bt50_with_logging.py` - Startup calibration
- **BLE Reset**: `tools/reset_ble.py` - Connection cleanup utility
- **Parser**: `src/impact_bridge/ble/wtvb_parse.py` - Frame parsing with raw count extraction

### Log Outputs
- **Calibration Logs**: `logs/calibration/bt50_*_20250909_174244.*`
- **Bridge Logs**: `logs/main/bridge_main_YYYYMMDD.csv` and `.ndjson`
- **Debug Logs**: `logs/debug/` for AMG protocol analysis and raw data inspection

## Next Steps

1. **Integrate Calibration**: Modify bridge startup to run calibration and update baselines
2. **Production Testing**: Validate with actual steel plate impacts
3. **Threshold Tuning**: Adjust 50-count threshold based on real impact data
4. **AMG Timer Integration**: Enhance shot detection with hex decoding
5. **System Deployment**: Package for production Raspberry Pi deployment

## Notes

- **Scale Factor Confusion Resolved**: No longer using 0.000425 vs 0.000902 - raw counts only
- **Baseline Subtraction Proven**: Simple `raw - baseline` approach works reliably  
- **AMG Protocol Decoded**: Complete 14-byte frame structure with shot/start/stop detection
- **Shot Over-Detection Eliminated**: Filter for 0x03 frame type achieves perfect accuracy
- **Connection Stability**: BLE reset tool resolves hanging connection issues
- **Dual Logging**: CSV and NDJSON formats provide comprehensive event tracking
- **Calibration Updated**: Fresh baseline X=2089 with 150-count threshold validated

---

**Handoff Date**: September 9, 2025  
**Status**: âœ… AMG Protocol Decoded, Ready for timing correlation analysis  
**Critical Next Action**: Parse AMG timing data for shot-to-impact correlation